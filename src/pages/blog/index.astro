---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import Header from '../../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';

const posts = (await getCollection('blog')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// å‡†å¤‡ç”¨äºæœç´¢çš„æ–‡ç« æ•°æ®
const postsData = posts.map(post => ({
	id: post.id,
	title: post.data.title,
	description: post.data.description,
	tags: post.data.tags || [],
	slug: post.id,
	heroImage: post.data.heroImage?.src || null,
	pubDate: post.data.pubDate.toISOString(),
}));
---

<!doctype html>
<html lang="zh-CN">
	<head>
		<BaseHead title={`åšå®¢ - ${SITE_TITLE}`} description={SITE_DESCRIPTION} />
		<style>
			main {
				width: 1000px;
				max-width: calc(100% - 2em);
			}

			.page-header {
				text-align: center;
				padding: 3em 0 2em;
				animation: fadeIn 0.8s ease-out;
			}

			@keyframes fadeIn {
				from {
					opacity: 0;
					transform: translateY(20px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			.page-title {
				font-size: 3rem;
				margin: 0 0 1rem;
				color: var(--accent);
			}

			.page-subtitle {
				font-size: 1.25rem;
				color: rgb(var(--gray));
				margin: 0;
			}

			.search-container {
				max-width: 600px;
				margin: 2rem auto;
				position: relative;
			}

			.search-box {
				position: relative;
				width: 100%;
			}

			.search-input {
				width: 100%;
				padding: 1rem 3rem 1rem 1.5rem;
				border: 2px solid rgb(var(--gray-light));
				border-radius: 50px;
				font-size: 1rem;
				transition: all 0.3s ease;
				background: white;
				box-shadow: var(--shadow-sm);
			}

			.search-input:focus {
				outline: none;
				border-color: var(--accent);
				box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.1);
				box-shadow: var(--shadow-md);
			}

			.search-icon {
				position: absolute;
				right: 1.5rem;
				top: 50%;
				transform: translateY(-50%);
				color: rgb(var(--gray));
				pointer-events: none;
			}

			.search-results-info {
				text-align: center;
				margin: 1rem 0;
				color: rgb(var(--gray));
				font-size: 0.95rem;
			}

			.no-results {
				text-align: center;
				padding: 4rem 2rem;
				color: rgb(var(--gray));
			}

			.no-results-icon {
				font-size: 4rem;
				margin-bottom: 1rem;
			}

			.posts-grid {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
				gap: 2rem;
				margin: 2rem 0;
			}

			.post-card {
				background: white;
				border-radius: 16px;
				overflow: hidden;
				box-shadow: var(--shadow-md);
				transition: all 0.3s ease;
				border: 1px solid rgba(5, 150, 105, 0.1);
				text-decoration: none;
				animation: fadeInUp 0.6s ease-out;
				animation-fill-mode: both;
			}

			@keyframes fadeInUp {
				from {
					opacity: 0;
					transform: translateY(30px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			.post-card:hover {
				transform: translateY(-8px);
				box-shadow: var(--shadow-xl);
				border-color: rgba(5, 150, 105, 0.3);
			}

			.post-image {
				width: 100%;
				height: 220px;
				overflow: hidden;
				position: relative;
			}

			.post-image img {
				width: 100%;
				height: 100%;
				object-fit: cover;
				border-radius: 0;
				transition: transform 0.5s ease;
			}

			.post-card:hover .post-image img {
				transform: scale(1.15);
			}

			.post-content {
				padding: 1.75rem;
			}

			.post-meta {
				display: flex;
				align-items: center;
				gap: 0.75rem;
				margin-bottom: 0.75rem;
			}

			.post-tag {
				display: inline-block;
				padding: 0.25rem 0.75rem;
				background: rgba(5, 150, 105, 0.1);
				color: var(--accent);
				border-radius: 20px;
				font-size: 0.75rem;
				font-weight: 600;
			}

			.post-title {
				margin: 0 0 0.75rem;
				font-size: 1.5rem;
				font-weight: 700;
				color: rgb(var(--black));
				line-height: 1.4;
				transition: color 0.2s ease;
			}

			.post-card:hover .post-title {
				color: var(--accent);
			}

			.post-excerpt {
				color: rgb(var(--gray));
				font-size: 0.95rem;
				line-height: 1.7;
				margin: 0 0 1rem;
				display: -webkit-box;
				-webkit-line-clamp: 3;
				-webkit-box-orient: vertical;
				overflow: hidden;
			}

			.post-footer {
				display: flex;
				align-items: center;
				justify-content: space-between;
				padding-top: 1rem;
				border-top: 1px solid rgb(var(--gray-light));
			}

			.post-date {
				color: var(--accent);
				font-size: 0.875rem;
				font-weight: 600;
			}

			.read-more {
				display: inline-flex;
				align-items: center;
				gap: 0.25rem;
				color: var(--accent);
				font-weight: 600;
				font-size: 0.875rem;
				transition: all 0.2s ease;
			}

			.read-more svg {
				width: 16px;
				height: 16px;
				transition: transform 0.2s ease;
			}

			.post-card:hover .read-more svg {
				transform: translateX(4px);
			}

			.highlight {
				background: linear-gradient(120deg, rgba(5, 150, 105, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%);
				background-repeat: no-repeat;
				background-size: 100% 40%;
				background-position: 0 85%;
				padding: 0 2px;
				border-radius: 2px;
			}

			@media (max-width: 720px) {
				.page-title {
					font-size: 2rem;
				}

				.search-container {
					margin: 1.5rem auto;
				}

				.posts-grid {
					grid-template-columns: 1fr;
					gap: 1.5rem;
				}

				.post-content {
					padding: 1.25rem;
				}

				.post-title {
					font-size: 1.25rem;
				}
			}
		</style>
	</head>
	<body>
		<Header />
		<main>
			<div class="page-header">
				<h1 class="page-title">ğŸ“š åšå®¢æ–‡ç« </h1>
				<p class="page-subtitle">åˆ†äº«æŠ€æœ¯ï¼Œè®°å½•ç”Ÿæ´»</p>
			</div>

			<div class="search-container">
				<div class="search-box">
					<input
						type="text"
						id="search-input"
						class="search-input"
						placeholder="æœç´¢æ–‡ç« æ ‡é¢˜ã€æè¿°æˆ–æ ‡ç­¾..."
						aria-label="æœç´¢æ–‡ç« "
					/>
					<svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<circle cx="11" cy="11" r="8"/>
						<path d="m21 21-4.35-4.35"/>
					</svg>
				</div>
				<div id="search-results-info" class="search-results-info"></div>
			</div>

			<section id="posts-grid" class="posts-grid">
				{
					posts.map((post) => (
						<a href={`/blog/${post.id}/`} class="post-card" data-post-id={post.id}>
							<div class="post-image">
								{post.data.heroImage && (
									<Image width={720} height={360} src={post.data.heroImage} alt={post.data.title} />
								)}
							</div>
							<div class="post-content">
								<div class="post-meta">
									<span class="post-tag">æŠ€æœ¯</span>
								</div>
								<h2 class="post-title">{post.data.title}</h2>
								<p class="post-excerpt">
									{post.data.description}
								</p>
								<div class="post-footer">
									<span class="post-date">
										<FormattedDate date={post.data.pubDate} />
									</span>
									<span class="read-more">
										é˜…è¯»æ›´å¤š
										<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
											<path d="M5 12h14M12 5l7 7-7 7"/>
										</svg>
									</span>
								</div>
							</div>
						</a>
					))
				}
			</section>

			<div id="no-results" class="no-results" style="display: none;">
				<div class="no-results-icon">ğŸ”</div>
				<h3>æœªæ‰¾åˆ°ç›¸å…³æ–‡ç« </h3>
				<p>è¯•è¯•å…¶ä»–å…³é”®è¯å§</p>
			</div>
		</main>
		<Footer />

		<script define:vars={{ postsData }}>
			const searchInput = document.getElementById('search-input');
			const postsGrid = document.getElementById('posts-grid');
			const noResults = document.getElementById('no-results');
			const searchResultsInfo = document.getElementById('search-results-info');

			// æœç´¢å‡½æ•°
			function searchPosts(query) {
				if (!query.trim()) {
					// æ˜¾ç¤ºæ‰€æœ‰æ–‡ç« 
					document.querySelectorAll('.post-card').forEach(card => {
						card.style.display = '';
					});
					noResults.style.display = 'none';
					searchResultsInfo.textContent = '';
					return;
				}

				const lowerQuery = query.toLowerCase();
				let matchCount = 0;

				postsData.forEach(post => {
					const card = document.querySelector(`[data-post-id="${post.id}"]`);
					if (!card) return;

					// æœç´¢æ ‡é¢˜ã€æè¿°å’Œæ ‡ç­¾
					const title = post.title.toLowerCase();
					const description = post.description.toLowerCase();
					const tags = (post.tags || []).join(' ').toLowerCase();

					const matches = title.includes(lowerQuery) ||
						description.includes(lowerQuery) ||
						tags.includes(lowerQuery);

					if (matches) {
						card.style.display = '';
						matchCount++;
						highlightText(card, query);
					} else {
						card.style.display = 'none';
					}
				});

				// æ˜¾ç¤º/éšè—æ— ç»“æœæç¤º
				if (matchCount === 0) {
					noResults.style.display = 'block';
					searchResultsInfo.textContent = '';
				} else {
					noResults.style.display = 'none';
					searchResultsInfo.textContent = `æ‰¾åˆ° ${matchCount} ç¯‡æ–‡ç« `;
				}
			}

			// é«˜äº®åŒ¹é…æ–‡æœ¬
			function highlightText(card, query) {
				const titleElement = card.querySelector('.post-title');
				const originalText = titleElement.textContent;

				if (!query.trim()) {
					titleElement.innerHTML = originalText;
					return;
				}

				const regex = new RegExp(`(${query})`, 'gi');
				const highlighted = originalText.replace(regex, '<span class="highlight">$1</span>');
				titleElement.innerHTML = highlighted;
			}

			// é˜²æŠ–
			let debounceTimer;
			searchInput.addEventListener('input', (e) => {
				clearTimeout(debounceTimer);
				debounceTimer = setTimeout(() => {
					searchPosts(e.target.value);
				}, 300);
			});

			// é¡µé¢åŠ è½½æ—¶èšç„¦æœç´¢æ¡†
			window.addEventListener('load', () => {
				searchInput.focus();
			});
		</script>
	</body>
</html>
